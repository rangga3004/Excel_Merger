<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* AHA Commerce Brand Colors */
        :root {
            --aha-blue-primary: #2563EB;
            --aha-blue-dark: #1D4ED8;
            --aha-blue-darker: #1E40AF;
            --aha-blue-light: #3B82F6;
            --aha-indigo: #4F46E5;
            --bg-gradient-start: #2563EB;
            --bg-gradient-end: #1D4ED8;
            --text-white: #FFFFFF;
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.7);
            --card-bg: #FFFBF0;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --button-dark: #1E3A5F;
            --success: #10B981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --error: #EF4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --radius-full: 9999px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }

        .container {
            width: 100%;
            max-width: 580px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .header {
            padding: 28px 28px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-white);
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .main {
            padding: 28px;
        }

        /* Upload Zone - Card Style like AHA bubbles */
        .upload-zone {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .upload-zone:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-zone.drag-over {
            transform: translateY(-4px);
            box-shadow: 0 0 0 3px var(--aha-blue-light), 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            color: var(--aha-blue-primary);
            margin-bottom: 16px;
        }

        .upload-zone h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--aha-blue-darker);
        }

        .upload-zone p {
            color: #64748B;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .browse-link {
            color: var(--aha-blue-primary);
            font-weight: 700;
            text-decoration: underline;
        }

        .hint {
            margin-top: 12px;
            font-size: 0.8rem !important;
            color: #94A3B8 !important;
        }

        /* Progress Section */
        .progress-section {
            display: none;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .progress-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--aha-blue-darker);
        }

        .progress-percent {
            color: var(--aha-blue-primary);
            font-weight: 700;
        }

        .progress-bar {
            height: 10px;
            background: #E2E8F0;
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--aha-blue-primary), var(--aha-indigo));
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        .progress-status {
            font-size: 0.85rem;
            color: #64748B;
            font-weight: 500;
        }

        /* File List Section */
        .file-list-section {
            display: none;
            margin-top: 20px;
        }

        .file-list-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .file-list-section h3 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-list {
            max-height: 180px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 8px;
            box-shadow: var(--card-shadow);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: #475569;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .file-item-icon {
            color: var(--aha-blue-primary);
            flex-shrink: 0;
        }

        .file-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-rows {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--aha-blue-primary);
            background: rgba(37, 99, 235, 0.1);
            padding: 3px 10px;
            border-radius: var(--radius-full);
        }

        /* Result Section */
        .result-section {
            display: none;
            text-align: center;
            padding: 28px 0;
        }

        .result-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            box-shadow: var(--card-shadow);
        }

        .result-icon {
            color: var(--success);
            margin-bottom: 16px;
        }

        .result-section h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--aha-blue-darker);
            font-weight: 800;
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--aha-blue-primary), var(--aha-indigo));
            padding: 14px 24px;
            border-radius: var(--radius-md);
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-white);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Buttons - AHA Style */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 32px;
            background: var(--button-dark);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
            background: #162D4A;
        }

        .reset-btn {
            display: block;
            margin: 16px auto 0;
            padding: 10px 24px;
            background: transparent;
            color: #64748B;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            background: #F1F5F9;
            color: var(--aha-blue-darker);
            border-color: var(--aha-blue-primary);
        }

        /* Error Section */
        .error-section {
            display: none;
            text-align: center;
            padding: 28px 0;
        }

        .error-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .error-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            box-shadow: var(--card-shadow);
        }

        .error-icon {
            color: var(--error);
            margin-bottom: 16px;
        }

        .error-section h2 {
            color: var(--error);
            margin-bottom: 12px;
            font-weight: 800;
        }

        .error-message {
            color: #64748B;
            background: var(--error-bg);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            padding: 16px 28px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .footer a {
            color: var(--text-white);
            text-decoration: none;
            font-weight: 700;
        }

        /* Scrollbar */
        .file-list::-webkit-scrollbar {
            width: 6px;
        }

        .file-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: rgba(37, 99, 235, 0.3);
            border-radius: 3px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: rgba(37, 99, 235, 0.5);
        }

        .upload-zone.hidden {
            display: none;
        }

        /* Column Selector Section */
        .column-selector-section {
            display: none;
            margin-top: 20px;
        }

        .column-selector-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .column-selector-section h3 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .column-selector-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .select-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .select-actions button {
            padding: 8px 16px;
            border: 2px solid var(--aha-blue-primary);
            background: transparent;
            color: var(--aha-blue-primary);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .select-actions button:hover {
            background: var(--aha-blue-primary);
            color: white;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 4px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .column-item:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .column-item.selected {
            background: rgba(37, 99, 235, 0.15);
            border-color: var(--aha-blue-primary);
        }

        .column-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--aha-blue-primary);
            cursor: pointer;
        }

        .column-item label {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .column-count {
            text-align: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E2E8F0;
        }

        .column-count span {
            font-size: 0.9rem;
            color: #64748B;
            font-weight: 500;
        }

        .column-count strong {
            color: var(--aha-blue-primary);
        }

        .proceed-btn {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 14px 32px;
            background: var(--button-dark);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        }

        .proceed-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
            background: #162D4A;
        }

        .proceed-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .column-search {
            margin-bottom: 12px;
        }

        .column-search input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s ease;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") 12px center no-repeat;
        }

        .column-search input:focus {
            outline: none;
            border-color: var(--aha-blue-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .column-search input::placeholder {
            color: #94A3B8;
        }

        .column-item.hidden {
            display: none;
        }

        .format-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #E2E8F0;
        }

        .swap-format-btn {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid var(--aha-blue-primary);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--aha-blue-primary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .swap-format-btn:hover {
            background: var(--aha-blue-primary);
            color: white;
        }

        .swap-format-btn.swapped {
            background: #10B981;
            border-color: #10B981;
            color: white;
        }

        .format-hint {
            font-size: 0.75rem;
            color: #64748B;
            margin-top: 6px;
            text-align: center;
        }

        .format-hint code {
            background: #F1F5F9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }

        .format-preview {
            margin-top: 12px;
            padding: 12px;
            background: #F8FAFC;
            border-radius: var(--radius-md);
            border: 1px solid #E2E8F0;
            overflow-x: auto;
            max-width: 100%;
        }

        .format-preview-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .format-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .format-badge.id-format {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .format-badge.us-format {
            background: #D1FAE5;
            color: #065F46;
        }

        .preview-table {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
        }

        .preview-table th,
        .preview-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-table th {
            background: #F1F5F9;
            font-weight: 600;
            color: #475569;
        }

        .row-settings {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 10px 12px;
            background: #F8FAFC;
            border-radius: var(--radius-md);
            border: 1px solid #E2E8F0;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .row-settings-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
        }

        .row-settings label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #64748B;
        }

        .row-settings input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #CBD5E1;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
        }

        .row-settings input[type="number"]:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .column-grid::-webkit-scrollbar {
            width: 6px;
        }

        .column-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .column-grid::-webkit-scrollbar-thumb {
            background: rgba(37, 99, 235, 0.3);
            border-radius: 3px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .tab-btn.active {
            background: var(--card-bg);
            color: var(--aha-blue-primary);
            box-shadow: var(--card-shadow);
        }

        .tab-btn svg {
            width: 18px;
            height: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Upload Type Selector (ZIP vs Excel) */
        .upload-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .upload-type-btn {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .upload-type-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .upload-type-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            color: var(--text-white);
        }

        /* Google Sheets Export Section */
        .export-options {
            margin-top: 16px;
            padding: 16px;
            background: #F8FAFC;
            border-radius: var(--radius-md);
            border: 1px solid #E2E8F0;
        }

        .export-options-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #475569;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .export-mode-btn {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-md);
            background: white;
            color: #64748B;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .export-mode-btn:hover {
            border-color: var(--aha-blue-primary);
            color: var(--aha-blue-primary);
        }

        .export-mode-btn.active {
            background: var(--aha-blue-primary);
            border-color: var(--aha-blue-primary);
            color: white;
        }

        .sheets-config {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #E2E8F0;
        }

        .sheets-config.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .sheets-input-group {
            margin-bottom: 12px;
        }

        .sheets-input-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 6px;
        }

        .sheets-input-group input[type="text"],
        .sheets-input-group input[type="number"],
        .sheets-input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .sheets-input-group input:focus,
        .sheets-input-group select:focus {
            outline: none;
            border-color: var(--aha-blue-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .sheets-input-group input::placeholder {
            color: #94A3B8;
        }

        .fetch-sheets-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--aha-blue-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .fetch-sheets-btn:hover {
            background: var(--aha-blue-dark);
        }

        .fetch-sheets-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sheets-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .sheets-status.success {
            background: var(--success-bg);
            color: #065F46;
        }

        .sheets-status.error {
            background: var(--error-bg);
            color: #991B1B;
        }

        .sheets-status.loading {
            background: rgba(37, 99, 235, 0.1);
            color: var(--aha-blue-primary);
        }

        .export-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .export-sheets-btn {
            flex: 1;
            padding: 12px 20px;
            background: #0F9D58;
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-sheets-btn:hover {
            background: #0B8043;
            transform: translateY(-1px);
        }

        .export-sheets-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Overlay for Export Operations */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-modal {
            background: white;
            border-radius: 20px;
            padding: 32px 40px;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            max-width: 320px;
            width: 90%;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid #E2E8F0;
            border-top-color: var(--aha-blue-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 8px;
        }

        .loading-status {
            font-size: 0.85rem;
            color: #64748B;
            margin-bottom: 16px;
        }

        .loading-progress-bar {
            width: 100%;
            height: 8px;
            background: #E2E8F0;
            border-radius: 4px;
            overflow: hidden;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--aha-blue-primary), #0F9D58);
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: progressPulse 1.5s ease-in-out infinite;
        }

        @keyframes progressPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .loading-percent {
            font-size: 0.75rem;
            color: #94A3B8;
            margin-top: 8px;
        }

        .loading-dismiss-btn {
            margin-top: 16px;
            padding: 8px 20px;
            background: transparent;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            color: #64748B;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .loading-dismiss-btn:hover {
            background: #F1F5F9;
            border-color: #CBD5E1;
            color: #475569;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid #0F9D58;
        }

        .toast.error {
            border-left-color: #DC2626;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            color: #1E293B;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.8rem;
            color: #64748B;
        }

        .toast-action {
            background: #0F9D58;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .toast-action:hover {
            background: #0B8043;
        }

        .toast-close {
            background: none;
            border: none;
            color: #94A3B8;
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Process History Tab Styles */
        .history-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            min-height: 200px;
        }

        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748B;
        }

        .history-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .history-item {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            border-color: #CBD5E1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .history-item.processing {
            border-left: 4px solid var(--aha-blue-primary);
        }

        .history-item.success {
            border-left: 4px solid #0F9D58;
        }

        .history-item.error {
            border-left: 4px solid #DC2626;
        }

        .history-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-filename {
            font-weight: 600;
            color: #1E293B;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            font-size: 0.8rem;
            color: #64748B;
            margin-top: 4px;
        }

        .history-progress {
            width: 100%;
            height: 6px;
            background: #E2E8F0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .history-progress-fill {
            height: 100%;
            background: var(--aha-blue-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .history-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .history-btn-primary {
            background: #0F9D58;
            color: white;
        }

        .history-btn-primary:hover {
            background: #0B8043;
        }

        .history-btn-secondary {
            background: #F1F5F9;
            color: #475569;
            border: 1px solid #E2E8F0;
        }

        .history-btn-secondary:hover {
            background: #E2E8F0;
        }

        .history-clear-btn {
            background: none;
            border: 1px solid #E2E8F0;
            color: #94A3B8;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .history-clear-btn:hover {
            background: #FEE2E2;
            border-color: #FECACA;
            color: #DC2626;
        }

        @media (max-width: 480px) {
            .container {
                border-radius: var(--radius-lg);
            }

            .header,
            .main {
                padding: 20px;
            }

            .upload-zone {
                padding: 32px 16px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .result-stats {
                gap: 10px;
            }

            .stat-item {
                padding: 12px 18px;
                min-width: 100px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <!-- AHA Commerce Logo -->
                <svg class="logo-icon" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 3L38 36H4L21 3Z" fill="white" />
                    <path d="M21 12L30 30H12L21 12Z" fill="#2563EB" />
                </svg>
                <h1>Excel Tools</h1>
            </div>
            <p class="subtitle">Pilih kolom atau gabungkan file Excel dengan mudah</p>
        </header>

        <main class="main">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="columnTab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    Pilih Kolom
                </button>
                <button class="tab-btn" data-tab="mergeTab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />
                    </svg>
                    Gabung File
                </button>
                <button class="tab-btn" data-tab="historyTab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Riwayat
                </button>
            </div>

            <!-- Tab: Pilih Kolom (Single File) -->
            <div class="tab-content active" id="columnTab">
                <div class="upload-zone" id="singleUploadZone">
                    <input type="file" id="singleFileInput" accept=".xlsx,.xls" hidden>
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="56" height="56" viewBox="0 0 56 56" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M28 38V18M28 18L20 26M28 18L36 26" stroke="currentColor" stroke-width="3"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 38V42C10 44.2091 11.7909 46 14 46H42C44.2091 46 46 44.2091 46 42V38"
                                    stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h2>Upload File Excel</h2>
                        <p>Drag & drop file Excel di sini, atau <span class="browse-link">browse</span></p>
                        <p class="hint">File Excel (.xlsx) untuk dipilih kolomnya</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Gabung File (ZIP / Multiple Excel) -->
            <div class="tab-content" id="mergeTab">
                <!-- Upload Type Selector -->
                <div class="upload-type-selector">
                    <button class="upload-type-btn active" data-type="zip">
                        📦 Upload ZIP
                    </button>
                    <button class="upload-type-btn" data-type="excel">
                        📄 Upload Excel Files
                    </button>
                </div>

                <!-- ZIP Upload Zone -->
                <div class="upload-zone" id="zipUploadZone">
                    <input type="file" id="zipFileInput" accept=".zip" hidden>
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="56" height="56" viewBox="0 0 56 56" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M28 38V18M28 18L20 26M28 18L36 26" stroke="currentColor" stroke-width="3"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 38V42C10 44.2091 11.7909 46 14 46H42C44.2091 46 46 44.2091 46 42V38"
                                    stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h2>Upload File ZIP</h2>
                        <p>Drag & drop file ZIP di sini, atau <span class="browse-link">browse</span></p>
                        <p class="hint">File ZIP berisi file Excel (.xlsx) yang akan digabungkan</p>
                    </div>
                </div>

                <!-- Multiple Excel Upload Zone -->
                <div class="upload-zone hidden" id="excelUploadZone">
                    <input type="file" id="excelFilesInput" accept=".xlsx,.xls" multiple hidden>
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="56" height="56" viewBox="0 0 56 56" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M28 38V18M28 18L20 26M28 18L36 26" stroke="currentColor" stroke-width="3"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 38V42C10 44.2091 11.7909 46 14 46H42C44.2091 46 46 44.2091 46 42V38"
                                    stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h2>Upload File Excel</h2>
                        <p>Drag & drop file Excel di sini, atau <span class="browse-link">browse</span></p>
                        <p class="hint">Pilih beberapa file Excel (.xlsx) untuk digabungkan</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Riwayat Export -->
            <div class="tab-content" id="historyTab">
                <div class="history-container" id="historyContainer">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 12px; border-bottom: 1px solid #E2E8F0;">
                        <h3 style="margin: 0; color: #1E293B; font-size: 1rem;">📜 Riwayat Export</h3>
                        <button class="history-clear-btn" id="clearHistoryBtn" style="display: none; margin: 0;">🗑️
                            Hapus Semua</button>
                    </div>
                    <div class="history-empty" id="historyEmpty">
                        <div class="history-empty-icon">📋</div>
                        <p style="color: #475569; font-weight: 500;">Belum ada riwayat export</p>
                        <p style="font-size: 0.8rem; color: #94A3B8;">Export ke Google Sheets untuk melihat riwayat di
                            sini</p>
                    </div>
                </div>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <span class="progress-title" id="progressTitle">Memproses...</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-status" id="progressStatus">Menunggu...</div>
            </div>

            <div class="file-list-section" id="fileListSection">
                <h3>File Excel Ditemukan</h3>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="column-selector-section" id="columnSelectorSection">
                <h3>Pilih Kolom untuk Download</h3>
                <div class="column-selector-card">
                    <div class="select-actions">
                        <button type="button" id="selectAllBtn">✓ Select All</button>
                        <button type="button" id="deselectAllBtn">✗ Deselect All</button>
                    </div>
                    <div class="column-search">
                        <input type="text" id="columnSearchInput" placeholder="Cari nama kolom...">
                    </div>
                    <div class="column-grid" id="columnGrid"></div>
                    <div class="column-count">
                        <span><strong id="selectedCount">0</strong> dari <strong id="totalCount">0</strong> kolom
                            dipilih</span>
                    </div>
                    <div class="row-settings">
                        <span class="row-settings-title">📊 Pengaturan Baris</span>
                        <label>Header di row: <input type="number" id="headerRowInput" value="1" min="1"></label>
                        <label>Data mulai row: <input type="number" id="dataStartRowInput" value="2" min="2"></label>
                    </div>
                    <div class="format-actions">
                        <button type="button" class="swap-format-btn" id="swapFormatBtn">
                            🔄 Swap Format (. ↔ ,)
                        </button>
                    </div>
                    <div class="format-preview" id="formatPreview">
                        <div class="format-preview-title">
                            Preview Data <span class="format-badge" id="formatBadge"></span>
                        </div>
                        <table class="preview-table">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <p class="format-hint">
                        Contoh: <code>1.234,56</code> ↔ <code>1,234.56</code>
                    </p>

                    <!-- Export Options Section -->
                    <div class="export-options">
                        <div class="export-options-title">📤 Export Destination</div>
                        <div class="export-mode-selector">
                            <button type="button" class="export-mode-btn active" data-mode="excel">
                                📄 Download Excel
                            </button>
                            <button type="button" class="export-mode-btn" data-mode="sheets">
                                📊 Google Sheets
                            </button>
                        </div>

                        <!-- Excel Download (default) -->
                        <div class="export-excel-config" id="exportExcelConfig">
                            <button class="proceed-btn" id="proceedBtn">📥 Download Kolom Terpilih</button>
                        </div>

                        <!-- Google Sheets Config -->
                        <div class="sheets-config" id="sheetsConfig">
                            <div class="export-mode-selector" style="margin-bottom: 12px;">
                                <button type="button" class="export-mode-btn active" data-sheets-mode="new">
                                    ✨ Spreadsheet Baru
                                </button>
                                <button type="button" class="export-mode-btn" data-sheets-mode="existing">
                                    📝 Spreadsheet Existing
                                </button>
                            </div>

                            <!-- New Spreadsheet (simple) -->
                            <div class="sheets-new-config" id="sheetsNewConfig">
                                <button class="export-sheets-btn" id="exportNewSheetBtn">
                                    📊 Buat Spreadsheet Baru
                                </button>
                            </div>

                            <!-- Existing Spreadsheet -->
                            <div class="sheets-existing-config" id="sheetsExistingConfig" style="display: none;">
                                <div class="sheets-input-group">
                                    <label>🔗 URL Spreadsheet</label>
                                    <input type="text" id="sheetsUrlInput"
                                        placeholder="https://docs.google.com/spreadsheets/d/...">
                                    <button class="fetch-sheets-btn" id="fetchSheetsBtn">🔍 Ambil List Sheets</button>
                                </div>
                                <div id="sheetsStatus"></div>
                                <div class="sheets-input-group" id="sheetSelectGroup" style="display: none;">
                                    <label>📑 Pilih Sheet</label>
                                    <select id="sheetSelect">
                                        <option value="">-- Pilih Sheet --</option>
                                    </select>
                                </div>
                                <div class="sheets-input-group" id="startCellGroup" style="display: none;">
                                    <label>📍 Mulai dari Cell (data akan overwrite dari cell ini)</label>
                                    <input type="text" id="sheetsStartCell" value="A1"
                                        placeholder="Contoh: A1, B5, AA10" style="text-transform: uppercase;">
                                    <p class="format-hint" style="margin-top: 6px; font-size: 0.75rem; color: #64748B;">
                                        Format: Column + Row, contoh: <code>A1</code>, <code>B5</code>,
                                        <code>AA10</code>
                                    </p>
                                </div>
                                <button class="export-sheets-btn" id="exportExistingSheetBtn" style="display: none;">
                                    📤 Export ke Spreadsheet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-card">
                    <div class="result-icon">
                        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" />
                            <path d="M18 28L24 34L38 20" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </div>
                    <h2>Merge Berhasil!</h2>
                    <div class="result-stats" id="resultStats"></div>
                    <button class="download-btn" id="downloadBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 3V11M9 11L5 7M9 11L13 7" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3 11V13C3 14.1046 3.89543 15 5 15H13C14.1046 15 15 14.1046 15 13V11"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Download Hasil Merge
                    </button>
                    <button class="reset-btn" id="resetBtn">Upload File Lain</button>
                </div>
            </div>

            <div class="error-section" id="errorSection">
                <div class="error-card">
                    <div class="error-icon">
                        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" />
                            <path d="M20 20L36 36M36 20L20 36" stroke="currentColor" stroke-width="3"
                                stroke-linecap="round" />
                        </svg>
                    </div>
                    <h2>Terjadi Kesalahan</h2>
                    <p class="error-message" id="errorMessage"></p>
                    <button class="reset-btn" id="errorResetBtn">Coba Lagi</button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Excel Tools v2.0 | <a href="#">AHA Commerce</a> Internal Tool</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // DOM Elements - Tabs
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        let currentTab = 'columnTab';

        // DOM Elements - Single File Tab
        const singleUploadZone = document.getElementById('singleUploadZone');
        const singleFileInput = document.getElementById('singleFileInput');

        // DOM Elements - ZIP Merge Tab
        const zipUploadZone = document.getElementById('zipUploadZone');
        const zipFileInput = document.getElementById('zipFileInput');

        // DOM Elements - Multiple Excel Upload
        const uploadTypeBtns = document.querySelectorAll('.upload-type-btn');
        const excelUploadZone = document.getElementById('excelUploadZone');
        const excelFilesInput = document.getElementById('excelFilesInput');

        // DOM Elements - Shared
        const progressSection = document.getElementById('progressSection');
        const progressTitle = document.getElementById('progressTitle');
        const progressPercent = document.getElementById('progressPercent');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const fileListSection = document.getElementById('fileListSection');
        const fileList = document.getElementById('fileList');
        const resultSection = document.getElementById('resultSection');
        const resultStats = document.getElementById('resultStats');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        const errorResetBtn = document.getElementById('errorResetBtn');

        let mergedWorkbook = null;
        let outputFileName = 'merged_excel.xlsx';
        let allMergedData = [];  // Store all data for column filtering
        let headerRow = null;    // Store header row separately
        let currentMode = 'single'; // 'single' or 'merge'
        let formatSwapped = false; // Track if format has been swapped

        const formatPreview = document.getElementById('formatPreview');
        const formatBadge = document.getElementById('formatBadge');
        const previewHeader = document.getElementById('previewHeader');
        const previewBody = document.getElementById('previewBody');
        const headerRowInput = document.getElementById('headerRowInput');
        const dataStartRowInput = document.getElementById('dataStartRowInput');

        // Row settings (0-based indices)
        let headerRowIndex = 0;  // Default: row 1 (index 0)
        let dataStartRowIndex = 1;  // Default: row 2 (index 1)

        // Tab Navigation
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        function switchTab(tabId) {
            currentTab = tabId;
            tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
            resetApp(); // Reset state when switching tabs
        }

        // Event Listeners - Single File Tab
        singleUploadZone.addEventListener('click', () => singleFileInput.click());
        singleUploadZone.addEventListener('dragover', (e) => handleDragOver(e, singleUploadZone));
        singleUploadZone.addEventListener('dragleave', (e) => handleDragLeave(e, singleUploadZone));
        singleUploadZone.addEventListener('drop', (e) => handleSingleDrop(e));
        singleFileInput.addEventListener('change', handleSingleFileSelect);

        // Event Listeners - ZIP Merge Tab
        zipUploadZone.addEventListener('click', () => zipFileInput.click());
        zipUploadZone.addEventListener('dragover', (e) => handleDragOver(e, zipUploadZone));
        zipUploadZone.addEventListener('dragleave', (e) => handleDragLeave(e, zipUploadZone));
        zipUploadZone.addEventListener('drop', (e) => handleZipDrop(e));
        zipFileInput.addEventListener('change', handleZipFileSelect);

        // Event Listeners - Upload Type Toggle
        uploadTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => switchUploadType(btn.dataset.type));
        });

        function switchUploadType(type) {
            uploadTypeBtns.forEach(b => b.classList.toggle('active', b.dataset.type === type));
            zipUploadZone.classList.toggle('hidden', type !== 'zip');
            excelUploadZone.classList.toggle('hidden', type !== 'excel');
        }

        // Event Listeners - Multiple Excel Upload
        excelUploadZone.addEventListener('click', () => excelFilesInput.click());
        excelUploadZone.addEventListener('dragover', (e) => handleDragOver(e, excelUploadZone));
        excelUploadZone.addEventListener('dragleave', (e) => handleDragLeave(e, excelUploadZone));
        excelUploadZone.addEventListener('drop', (e) => handleMultipleExcelDrop(e));
        excelFilesInput.addEventListener('change', handleMultipleExcelSelect);

        // Shared Event Listeners
        downloadBtn.addEventListener('click', downloadMergedFile);
        resetBtn.addEventListener('click', resetApp);
        errorResetBtn.addEventListener('click', resetApp);

        // Column selector elements
        const columnSelectorSection = document.getElementById('columnSelectorSection');
        const columnGrid = document.getElementById('columnGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const proceedBtn = document.getElementById('proceedBtn');
        const selectedCountEl = document.getElementById('selectedCount');
        const totalCountEl = document.getElementById('totalCount');
        const columnSearchInput = document.getElementById('columnSearchInput');
        const swapFormatBtn = document.getElementById('swapFormatBtn');

        // DOM Elements - Google Sheets Export
        const exportModeBtns = document.querySelectorAll('.export-mode-btn[data-mode]');
        const exportExcelConfig = document.getElementById('exportExcelConfig');
        const sheetsConfig = document.getElementById('sheetsConfig');
        const sheetsModeBtns = document.querySelectorAll('.export-mode-btn[data-sheets-mode]');
        const sheetsNewConfig = document.getElementById('sheetsNewConfig');
        const sheetsExistingConfig = document.getElementById('sheetsExistingConfig');
        const sheetsUrlInput = document.getElementById('sheetsUrlInput');
        const fetchSheetsBtn = document.getElementById('fetchSheetsBtn');
        const sheetsStatus = document.getElementById('sheetsStatus');
        const sheetSelectGroup = document.getElementById('sheetSelectGroup');
        const sheetSelect = document.getElementById('sheetSelect');
        const startCellGroup = document.getElementById('startCellGroup');
        const sheetsStartCell = document.getElementById('sheetsStartCell');
        const exportNewSheetBtn = document.getElementById('exportNewSheetBtn');
        const exportExistingSheetBtn = document.getElementById('exportExistingSheetBtn');

        selectAllBtn.addEventListener('click', () => toggleAllColumns(true));
        deselectAllBtn.addEventListener('click', () => toggleAllColumns(false));
        proceedBtn.addEventListener('click', downloadMergedFile);
        columnSearchInput.addEventListener('input', filterColumns);
        swapFormatBtn.addEventListener('click', swapNumberFormat);

        // Export Mode Toggle (Excel vs Sheets)
        exportModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                exportModeBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
                exportExcelConfig.style.display = mode === 'excel' ? 'block' : 'none';
                sheetsConfig.classList.toggle('active', mode === 'sheets');
            });
        });

        // Sheets Mode Toggle (New vs Existing)
        sheetsModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.sheetsMode;
                sheetsModeBtns.forEach(b => b.classList.toggle('active', b.dataset.sheetsMode === mode));
                sheetsNewConfig.style.display = mode === 'new' ? 'block' : 'none';
                sheetsExistingConfig.style.display = mode === 'existing' ? 'block' : 'none';
            });
        });

        // Fetch Sheets Button
        fetchSheetsBtn.addEventListener('click', fetchSheetNames);

        // Export Buttons
        exportNewSheetBtn.addEventListener('click', exportToNewSpreadsheet);
        exportExistingSheetBtn.addEventListener('click', exportToExistingSpreadsheet);

        // Sheet selection change
        sheetSelect.addEventListener('change', () => {
            const hasSelection = sheetSelect.value !== '';
            startCellGroup.style.display = hasSelection ? 'block' : 'none';
            exportExistingSheetBtn.style.display = hasSelection ? 'flex' : 'none';
        });

        // Row settings event listeners
        headerRowInput.addEventListener('change', handleRowSettingsChange);
        dataStartRowInput.addEventListener('change', handleRowSettingsChange);

        function handleRowSettingsChange() {
            const newHeaderRow = parseInt(headerRowInput.value) || 1;
            const newDataStart = parseInt(dataStartRowInput.value) || 2;

            // Validate: data must start after header
            if (newDataStart <= newHeaderRow) {
                dataStartRowInput.value = newHeaderRow + 1;
            }

            // Update indices (convert to 0-based)
            headerRowIndex = Math.max(0, newHeaderRow - 1);
            dataStartRowIndex = Math.max(headerRowIndex + 1, (parseInt(dataStartRowInput.value) || 2) - 1);

            // Refresh column names if header changed
            if (allMergedData.length > 0) {
                refreshColumnHeaders();
                updatePreview();
            }
        }

        function refreshColumnHeaders() {
            const headers = allMergedData[headerRowIndex] || [];
            columnGrid.innerHTML = headers.map((header, index) => {
                const displayName = header || `Kolom ${index + 1}`;
                return `
                    <div class="column-item selected" data-index="${index}">
                        <input type="checkbox" id="col_${index}" checked>
                        <label for="col_${index}" title="${displayName}">${displayName}</label>
                    </div>
                `;
            }).join('');

            // Re-attach click handlers
            document.querySelectorAll('.column-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                    item.classList.toggle('selected', item.querySelector('input').checked);
                    updateColumnCount();
                    updatePreview();
                });
            });

            totalCountEl.textContent = headers.length;
            updateColumnCount();
        }

        function handleDragOver(e, zone) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.add('drag-over');
        }

        function handleDragLeave(e, zone) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.remove('drag-over');
        }

        // Single File Handlers
        function handleSingleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            singleUploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) processSingleFile(files[0]);
        }

        function handleSingleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processSingleFile(files[0]);
        }

        // ZIP File Handlers
        function handleZipDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            zipUploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) processZipFile(files[0]);
        }

        function handleZipFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processZipFile(files[0]);
        }

        // Multiple Excel File Handlers
        function handleMultipleExcelDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            excelUploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) processMultipleExcelFiles(files);
        }

        function handleMultipleExcelSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processMultipleExcelFiles(files);
        }

        // Process Multiple Excel Files (Merge)
        async function processMultipleExcelFiles(fileList) {
            // Filter only Excel files
            const files = Array.from(fileList).filter(f => {
                const name = f.name.toLowerCase();
                return name.endsWith('.xlsx') || name.endsWith('.xls');
            });

            if (files.length === 0) {
                showError('Tidak ditemukan file Excel (.xlsx atau .xls)');
                return;
            }

            if (files.length < 2) {
                showError('Pilih minimal 2 file Excel untuk digabungkan');
                return;
            }

            currentMode = 'merge';
            outputFileName = 'merged_excel.xlsx';
            excelUploadZone.classList.add('hidden');
            showProgress();

            try {
                updateProgress(10, 'Mempersiapkan file...');

                // Sort files by name (natural sort)
                files.sort((a, b) => naturalSort(a.name, b.name));

                updateProgress(20, `Memproses ${files.length} file Excel...`);

                const allData = [];
                let currentHeaderRow = null;
                let totalRows = 0;
                const fileStats = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progressPct = 20 + Math.round((i / files.length) * 60);
                    updateProgress(progressPct, `Memproses: ${file.name}`);

                    const excelData = await readFileAsArrayBuffer(file);
                    const workbook = XLSX.read(excelData, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    if (jsonData.length === 0) continue;

                    let dataRows;
                    if (currentHeaderRow === null) {
                        currentHeaderRow = jsonData[0];
                        dataRows = jsonData;
                    } else {
                        dataRows = jsonData.slice(1);
                    }

                    const rowCount = dataRows.length - (currentHeaderRow === jsonData[0] ? 1 : 0);
                    fileStats.push({ name: file.name, rows: rowCount });
                    totalRows += rowCount;
                    allData.push(...dataRows);
                }

                displayFileList(fileStats);

                updateProgress(85, 'Menyiapkan pemilihan kolom...');

                // Store data globally for column filtering
                allMergedData = allData;
                headerRow = currentHeaderRow;

                updateProgress(100, 'Selesai!');

                setTimeout(() => {
                    showColumnSelector(currentHeaderRow, files.length, totalRows);
                }, 500);

            } catch (error) {
                console.error('Error processing files:', error);
                showError(error.message || 'Terjadi kesalahan saat memproses file');
            }
        }

        // Process Single Excel File
        async function processSingleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showError('File harus berformat .xlsx atau .xls');
                return;
            }

            currentMode = 'single';
            outputFileName = file.name.replace(/\.(xlsx|xls)$/i, '_filtered.xlsx');
            singleUploadZone.classList.add('hidden');
            showProgress();

            try {
                updateProgress(20, 'Membaca file Excel...');
                const excelData = await readFileAsArrayBuffer(file);

                updateProgress(50, 'Memproses data...');
                const workbook = XLSX.read(excelData, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                if (jsonData.length === 0) {
                    throw new Error('File Excel kosong');
                }

                // Store data globally
                allMergedData = jsonData;
                headerRow = jsonData[0];

                updateProgress(100, 'Selesai!');

                setTimeout(() => {
                    showColumnSelector(headerRow, 1, jsonData.length - 1);
                }, 500);

            } catch (error) {
                console.error('Error processing file:', error);
                showError(error.message || 'Terjadi kesalahan saat memproses file');
            }
        }

        // Process ZIP File (Merge)
        async function processZipFile(file) {
            if (!file.name.toLowerCase().endsWith('.zip')) {
                showError('File harus berformat .zip');
                return;
            }

            currentMode = 'merge';

            outputFileName = file.name.replace('.zip', '_merged.xlsx');
            zipUploadZone.classList.add('hidden');
            showProgress();

            try {
                updateProgress(10, 'Membaca file ZIP...');
                const zipData = await readFileAsArrayBuffer(file);

                updateProgress(20, 'Mengekstrak file ZIP...');
                const zip = await JSZip.loadAsync(zipData);

                updateProgress(30, 'Mencari file Excel...');
                const excelFiles = [];

                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir && relativePath.toLowerCase().endsWith('.xlsx')) {
                        if (!relativePath.startsWith('~$') && !relativePath.includes('/__MACOSX/')) {
                            excelFiles.push({
                                path: relativePath,
                                name: relativePath.split('/').pop(),
                                entry: zipEntry
                            });
                        }
                    }
                });

                if (excelFiles.length === 0) {
                    throw new Error('Tidak ditemukan file Excel (.xlsx) dalam ZIP');
                }

                excelFiles.sort((a, b) => naturalSort(a.name, b.name));

                updateProgress(40, `Memproses ${excelFiles.length} file Excel...`);

                const allData = [];
                let currentHeaderRow = null;
                let totalRows = 0;
                const fileStats = [];

                for (let i = 0; i < excelFiles.length; i++) {
                    const excelFile = excelFiles[i];
                    const progressPct = 40 + Math.round((i / excelFiles.length) * 40);
                    updateProgress(progressPct, `Memproses: ${excelFile.name}`);

                    const excelData = await excelFile.entry.async('arraybuffer');
                    const workbook = XLSX.read(excelData, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    if (jsonData.length === 0) continue;

                    let dataRows;
                    if (currentHeaderRow === null) {
                        currentHeaderRow = jsonData[0];
                        dataRows = jsonData;
                    } else {
                        dataRows = jsonData.slice(1);
                    }

                    const rowCount = dataRows.length - (currentHeaderRow === jsonData[0] ? 1 : 0);
                    fileStats.push({ name: excelFile.name, rows: rowCount });
                    totalRows += rowCount;
                    allData.push(...dataRows);
                }

                displayFileList(fileStats);

                updateProgress(85, 'Menyiapkan pemilihan kolom...');

                // Store data globally for column filtering
                allMergedData = allData;
                headerRow = currentHeaderRow;

                updateProgress(100, 'Selesai!');

                setTimeout(() => {
                    showColumnSelector(currentHeaderRow, excelFiles.length, totalRows);
                }, 500);

            } catch (error) {
                console.error('Error processing file:', error);
                showError(error.message || 'Terjadi kesalahan saat memproses file');
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Gagal membaca file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function naturalSort(a, b) {
            const ax = [], bx = [];
            a.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { ax.push([$1 || Infinity, $2 || '']) });
            b.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { bx.push([$1 || Infinity, $2 || '']) });
            while (ax.length && bx.length) {
                const an = ax.shift();
                const bn = bx.shift();
                const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]);
                if (nn) return nn;
            }
            return ax.length - bx.length;
        }

        function calculateColumnWidths(data) {
            if (!data || data.length === 0) return [];
            const colWidths = [];
            const maxWidth = 50;
            const minWidth = 10;
            const maxCols = Math.max(...data.map(row => (row ? row.length : 0)));
            for (let col = 0; col < maxCols; col++) {
                let maxLen = minWidth;
                const sampleSize = Math.min(data.length, 100);
                for (let row = 0; row < sampleSize; row++) {
                    if (data[row] && data[row][col] !== undefined) {
                        const cellLen = String(data[row][col]).length;
                        if (cellLen > maxLen) maxLen = cellLen;
                    }
                }
                colWidths.push({ wch: Math.min(maxLen + 2, maxWidth) });
            }
            return colWidths;
        }

        function displayFileList(fileStats) {
            fileList.innerHTML = fileStats.map(file => `
                <div class="file-item">
                    <div class="file-item-icon">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M3 2H10L13 5V14H3V2Z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M10 2V5H13" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <span class="file-item-name">${file.name}</span>
                    <span class="file-item-rows">${file.rows.toLocaleString()} rows</span>
                </div>
            `).join('');
            fileListSection.classList.add('active');
        }

        function updateProgress(percent, status) {
            progressPercent.textContent = `${percent}%`;
            progressFill.style.width = `${percent}%`;
            progressStatus.textContent = status;
        }

        function showProgress() {
            progressSection.classList.add('active');
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            updateProgress(0, 'Memulai...');
        }

        function showResult(fileCount, rowCount) {
            progressSection.classList.remove('active');
            resultSection.classList.add('active');
            resultStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${fileCount}</div>
                    <div class="stat-label">File Digabung</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${rowCount.toLocaleString()}</div>
                    <div class="stat-label">Total Baris</div>
                </div>
            `;
        }

        function showError(message) {
            singleUploadZone.classList.add('hidden');
            zipUploadZone.classList.add('hidden');
            excelUploadZone.classList.add('hidden');
            progressSection.classList.remove('active');
            resultSection.classList.remove('active');
            fileListSection.classList.remove('active');
            errorSection.classList.add('active');
            errorMessage.textContent = message;
        }

        function downloadMergedFile() {
            const selectedColumns = getSelectedColumns();
            if (selectedColumns.length === 0) {
                showError('Pilih minimal 1 kolom untuk download');
                return;
            }

            try {
                // Get header row
                const headerData = allMergedData[headerRowIndex] || [];
                const filteredHeader = selectedColumns.map(colIndex =>
                    headerData[colIndex] !== undefined ? headerData[colIndex] : ''
                );

                // Get data rows (from dataStartRowIndex onwards)
                const dataRows = allMergedData.slice(dataStartRowIndex);
                const filteredDataRows = dataRows.map(row =>
                    selectedColumns.map(colIndex => row[colIndex] !== undefined ? row[colIndex] : '')
                );

                // Combine header + data
                const filteredData = [filteredHeader, ...filteredDataRows];

                // Create workbook with filtered data
                mergedWorkbook = XLSX.utils.book_new();
                const mergedSheet = XLSX.utils.aoa_to_sheet(filteredData);
                const colWidths = calculateColumnWidths(filteredData);
                mergedSheet['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(mergedWorkbook, mergedSheet, 'Merged Data');

                const wbout = XLSX.write(mergedWorkbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, outputFileName);
            } catch (error) {
                console.error('Error downloading file:', error);
                showError('Gagal mendownload file');
            }
        }

        function resetApp() {
            mergedWorkbook = null;
            allMergedData = [];
            headerRow = null;
            outputFileName = 'merged_excel.xlsx';
            formatSwapped = false;
            swapFormatBtn.classList.remove('swapped');
            swapFormatBtn.innerHTML = '🔄 Swap Format (. ↔ ,)';
            singleFileInput.value = '';
            zipFileInput.value = '';
            excelFilesInput.value = '';
            singleUploadZone.classList.remove('hidden');
            // Restore ZIP/Excel upload zones based on current toggle state
            const activeUploadType = document.querySelector('.upload-type-btn.active');
            if (activeUploadType && activeUploadType.dataset.type === 'excel') {
                zipUploadZone.classList.add('hidden');
                excelUploadZone.classList.remove('hidden');
            } else {
                zipUploadZone.classList.remove('hidden');
                excelUploadZone.classList.add('hidden');
            }
            progressSection.classList.remove('active');
            fileListSection.classList.remove('active');
            columnSelectorSection.classList.remove('active');
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            fileList.innerHTML = '';
            columnGrid.innerHTML = '';
            updateProgress(0, 'Menunggu...');
            // Reset row settings
            headerRowIndex = 0;
            dataStartRowIndex = 1;
            headerRowInput.value = 1;
            dataStartRowInput.value = 2;
        }

        // Column Selector Functions
        function showColumnSelector(headers, fileCount, rowCount) {
            progressSection.classList.remove('active');
            columnSelectorSection.classList.add('active');

            // Render column checkboxes
            columnGrid.innerHTML = headers.map((header, index) => {
                const displayName = header || `Kolom ${index + 1}`;
                return `
                    <div class="column-item selected" data-index="${index}">
                        <input type="checkbox" id="col_${index}" checked>
                        <label for="col_${index}" title="${displayName}">${displayName}</label>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.column-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Only manually toggle if clicking outside checkbox and label
                    // (label already toggles checkbox natively via 'for' attribute)
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                    item.classList.toggle('selected', item.querySelector('input').checked);
                    updateColumnCount();
                    updatePreview();
                });
            });

            totalCountEl.textContent = headers.length;
            updateColumnCount();

            // Store stats for result display
            columnSelectorSection.dataset.fileCount = fileCount;
            columnSelectorSection.dataset.rowCount = rowCount;

            // Update preview with sample data and detected format
            updatePreview();
        }

        function toggleAllColumns(selectAll) {
            // Only toggle visible (non-hidden) columns
            document.querySelectorAll('.column-item:not(.hidden)').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = selectAll;
                item.classList.toggle('selected', selectAll);
            });
            updateColumnCount();
            updatePreview();
        }


        // Auto-detect number format from data
        function detectNumberFormat() {
            let idFormatCount = 0;  // 1.234,56
            let usFormatCount = 0;  // 1,234.56

            // Sample first 100 data rows (skip header)
            const sampleSize = Math.min(100, allMergedData.length - 1);
            for (let i = 1; i <= sampleSize; i++) {
                for (let j = 0; j < allMergedData[i].length; j++) {
                    const cell = String(allMergedData[i][j] || '');
                    // ID format: has dot as thousand separator, comma as decimal (1.234,56)
                    if (/\d{1,3}(\.\d{3})+,\d+/.test(cell)) idFormatCount++;
                    // US format: has comma as thousand separator, dot as decimal (1,234.56)
                    if (/\d{1,3}(,\d{3})+\.\d+/.test(cell)) usFormatCount++;
                }
            }

            if (idFormatCount > usFormatCount) return 'ID';
            if (usFormatCount > idFormatCount) return 'US';
            return null; // Unknown
        }

        // Update preview table with sample data (filtered by selected columns)
        function updatePreview() {
            if (allMergedData.length < 2) return;

            // Detect format
            const detectedFormat = detectNumberFormat();
            formatBadge.textContent = detectedFormat ?
                (detectedFormat === 'ID' ? 'ID Format (1.234,56)' : 'US Format (1,234.56)') :
                'Format tidak dikenali';
            formatBadge.className = 'format-badge ' +
                (detectedFormat === 'ID' ? 'id-format' : detectedFormat === 'US' ? 'us-format' : '');

            // Get selected column indices
            const selectedIndices = getSelectedColumns();
            if (selectedIndices.length === 0) {
                previewHeader.innerHTML = '<tr><th>Tidak ada kolom dipilih</th></tr>';
                previewBody.innerHTML = '';
                return;
            }

            // Filter headers and rows by selected columns, using row settings
            const headers = selectedIndices.map(i => (allMergedData[headerRowIndex] || [])[i]);
            const previewRows = allMergedData.slice(dataStartRowIndex, dataStartRowIndex + 2).map(row =>
                selectedIndices.map(i => row[i])
            );

            // Render header
            previewHeader.innerHTML = '<tr>' + headers.map(h =>
                '<th title="' + (h || '') + '">' + (h || '-') + '</th>'
            ).join('') + '</tr>';

            // Render body
            previewBody.innerHTML = previewRows.map(row =>
                '<tr>' + row.map(cell =>
                    '<td title="' + (cell || '') + '">' + (cell || '-') + '</td>'
                ).join('') + '</tr>'
            ).join('');
        }
        function filterColumns() {
            const searchTerm = columnSearchInput.value.toLowerCase().trim();
            document.querySelectorAll('.column-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const matches = label.includes(searchTerm);
                item.classList.toggle('hidden', !matches);
            });
        }

        function swapNumberFormat() {
            // Swap . and , in all data cells (skip header, start from data row)
            for (let i = dataStartRowIndex; i < allMergedData.length; i++) {
                for (let j = 0; j < allMergedData[i].length; j++) {
                    let cell = allMergedData[i][j];
                    if (typeof cell === 'string' && /[\d.,]/.test(cell)) {
                        // Use placeholder to avoid double replacement
                        cell = cell.replace(/\./g, '###PLACEHOLDER###');
                        cell = cell.replace(/,/g, '.');
                        cell = cell.replace(/###PLACEHOLDER###/g, ',');
                        allMergedData[i][j] = cell;
                    }
                }
            }

            // Toggle button state
            formatSwapped = !formatSwapped;
            swapFormatBtn.classList.toggle('swapped', formatSwapped);
            swapFormatBtn.innerHTML = formatSwapped
                ? '✓ Format Sudah Di-swap'
                : '🔄 Swap Format (. ↔ ,)';

            // Update preview
            updatePreview();
        }

        function resetFormatToDefault() {
            // If currently swapped, swap back first
            if (formatSwapped) {
                swapNumberFormat(); // This will toggle back
            }
            // Clear session preference
            formatSwapped = false;
            swapFormatBtn.classList.remove('swapped');
            swapFormatBtn.innerHTML = '🔄 Swap Format (. ↔ ,)';
        }

        function getSelectedColumns() {
            const selected = [];
            document.querySelectorAll('.column-item input:checked').forEach(checkbox => {
                const item = checkbox.closest('.column-item');
                selected.push(parseInt(item.dataset.index));
            });
            return selected.sort((a, b) => a - b);
        }

        function updateColumnCount() {
            const count = document.querySelectorAll('.column-item input:checked').length;
            selectedCountEl.textContent = count;
            proceedBtn.disabled = count === 0;
            proceedBtn.textContent = count === 0 ? 'Pilih Kolom Terlebih Dahulu' : `📥 Download ${count} Kolom Terpilih`;

            // Also update export buttons
            exportNewSheetBtn.disabled = count === 0;
            exportExistingSheetBtn.disabled = count === 0;
        }

        // ============================================
        // GOOGLE SHEETS EXPORT FUNCTIONS
        // ============================================

        function getExportData() {
            const selectedCols = getSelectedColumns();
            if (selectedCols.length === 0) return null;

            // Build data with selected columns only
            const data = [];

            // Add header row
            const headers = allMergedData[headerRowIndex] || [];
            data.push(selectedCols.map(i => headers[i] || ''));

            // Add data rows
            for (let i = dataStartRowIndex; i < allMergedData.length; i++) {
                const row = allMergedData[i];
                data.push(selectedCols.map(j => row[j] !== undefined ? row[j] : ''));
            }

            return data;
        }

        function showSheetsStatus(message, type) {
            sheetsStatus.innerHTML = `<div class="sheets-status ${type}">${message}</div>`;
        }

        function fetchSheetNames() {
            const url = sheetsUrlInput.value.trim();
            if (!url) {
                showSheetsStatus('⚠️ Masukkan URL spreadsheet terlebih dahulu', 'error');
                return;
            }

            if (!url.includes('docs.google.com/spreadsheets')) {
                showSheetsStatus('⚠️ URL tidak valid. Gunakan URL Google Spreadsheet', 'error');
                return;
            }

            fetchSheetsBtn.disabled = true;
            fetchSheetsBtn.textContent = '⏳ Mengambil data...';
            showSheetsStatus('🔄 Mengambil list sheets...', 'loading');

            google.script.run
                .withSuccessHandler(function (result) {
                    fetchSheetsBtn.disabled = false;
                    fetchSheetsBtn.textContent = '🔍 Ambil List Sheets';

                    if (result.success) {
                        showSheetsStatus(`✅ Spreadsheet: "${result.spreadsheetName}"`, 'success');

                        // Populate dropdown
                        sheetSelect.innerHTML = '<option value="">-- Pilih Sheet --</option>';
                        result.sheets.forEach(name => {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            sheetSelect.appendChild(option);
                        });

                        sheetSelectGroup.style.display = 'block';
                    } else {
                        showSheetsStatus('❌ ' + result.error, 'error');
                        sheetSelectGroup.style.display = 'none';
                        startCellGroup.style.display = 'none';
                        exportExistingSheetBtn.style.display = 'none';
                    }
                })
                .withFailureHandler(function (error) {
                    fetchSheetsBtn.disabled = false;
                    fetchSheetsBtn.textContent = '🔍 Ambil List Sheets';
                    showSheetsStatus('❌ Error: ' + error.message, 'error');
                })
                .getSpreadsheetSheets(url);
        }

        function exportToNewSpreadsheet() {
            const data = getExportData();
            if (!data) {
                alert('Pilih minimal 1 kolom untuk di-export');
                return;
            }

            const filename = outputFileName.replace('.xlsx', '') + ' - Export';

            // Add to history
            const historyId = addToHistory(filename, 'new');

            exportNewSheetBtn.disabled = true;
            exportNewSheetBtn.textContent = '⏳ Membuat spreadsheet...';
            showLoadingOverlay('📊 Membuat Spreadsheet', 'Menghubungkan ke Google Sheets...', historyId);

            google.script.run
                .withSuccessHandler(function (result) {
                    const dismissed = wasDismissed();
                    hideLoadingOverlay();
                    exportNewSheetBtn.disabled = false;
                    exportNewSheetBtn.textContent = '📊 Buat Spreadsheet Baru';

                    if (result.success) {
                        updateHistoryItem(historyId, { status: 'success', url: result.url });
                        if (dismissed) {
                            // User dismissed, show toast instead of modal
                            showToast('Spreadsheet Selesai', 'Spreadsheet baru berhasil dibuat!', result.url);
                        } else {
                            showSpreadsheetLink(result.url, 'Spreadsheet baru berhasil dibuat!');
                        }
                    } else {
                        updateHistoryItem(historyId, { status: 'error', error: result.error });
                        if (dismissed) {
                            showToast('Export Gagal', result.error, null, true);
                        } else {
                            alert('❌ Gagal: ' + result.error);
                        }
                    }
                })
                .withFailureHandler(function (error) {
                    const dismissed = wasDismissed();
                    hideLoadingOverlay();
                    exportNewSheetBtn.disabled = false;
                    exportNewSheetBtn.textContent = '📊 Buat Spreadsheet Baru';
                    updateHistoryItem(historyId, { status: 'error', error: error.message });
                    if (dismissed) {
                        showToast('Export Error', error.message, null, true);
                    } else {
                        alert('❌ Error: ' + error.message);
                    }
                })
                .createNewSpreadsheet(data, filename);
        }

        function exportToExistingSpreadsheet() {
            const data = getExportData();
            if (!data) {
                alert('Pilih minimal 1 kolom untuk di-export');
                return;
            }

            const url = sheetsUrlInput.value.trim();
            const sheetName = sheetSelect.value;
            const cellRef = sheetsStartCell.value.trim().toUpperCase() || 'A1';

            // Parse cell reference
            const parsed = parseCellReference(cellRef);
            if (!parsed) {
                alert('Format cell tidak valid. Gunakan format seperti A1, B5, AA10');
                return;
            }

            if (!url || !sheetName) {
                alert('Pilih URL dan Sheet terlebih dahulu');
                return;
            }

            // Add to history
            const filename = outputFileName.replace('.xlsx', '') + ' - Export';
            const historyId = addToHistory(filename, 'existing', sheetName, cellRef);

            exportExistingSheetBtn.disabled = true;
            exportExistingSheetBtn.textContent = '⏳ Mengexport...';
            showLoadingOverlay('📤 Export ke Spreadsheet', `Menulis data ke "${sheetName}"...`, historyId);

            google.script.run
                .withSuccessHandler(function (result) {
                    const dismissed = wasDismissed();
                    hideLoadingOverlay();
                    exportExistingSheetBtn.disabled = false;
                    exportExistingSheetBtn.textContent = '📤 Export ke Spreadsheet';

                    if (result.success) {
                        updateHistoryItem(historyId, { status: 'success', url: result.url });
                        if (dismissed) {
                            showToast('Export Selesai', `${result.rowsWritten} baris ditulis ke "${sheetName}"`, result.url);
                        } else {
                            showSpreadsheetLink(result.url, `Export berhasil! ${result.rowsWritten} baris ditulis ke "${sheetName}" mulai dari ${cellRef}.`);
                        }
                    } else {
                        updateHistoryItem(historyId, { status: 'error', error: result.error });
                        if (dismissed) {
                            showToast('Export Gagal', result.error, null, true);
                        } else {
                            alert('❌ Gagal: ' + result.error);
                        }
                    }
                })
                .withFailureHandler(function (error) {
                    const dismissed = wasDismissed();
                    hideLoadingOverlay();
                    exportExistingSheetBtn.disabled = false;
                    exportExistingSheetBtn.textContent = '📤 Export ke Spreadsheet';
                    updateHistoryItem(historyId, { status: 'error', error: error.message });
                    if (dismissed) {
                        showToast('Export Error', error.message, null, true);
                    } else {
                        alert('❌ Error: ' + error.message);
                    }
                })
                .exportToExistingSheet(url, sheetName, parsed.row, parsed.col, data);
        }

        // Parse cell reference like "A1", "B5", "AA10" into {col, row}
        function parseCellReference(cellRef) {
            const match = cellRef.match(/^([A-Z]+)(\d+)$/i);
            if (!match) return null;

            const colLetters = match[1].toUpperCase();
            const row = parseInt(match[2]);

            if (row < 1) return null;

            // Convert column letters to number (A=1, B=2, ..., Z=26, AA=27, etc.)
            let col = 0;
            for (let i = 0; i < colLetters.length; i++) {
                col = col * 26 + (colLetters.charCodeAt(i) - 64);
            }

            return { col, row };
        }

        // Show spreadsheet link modal (avoids popup blocker)
        function showSpreadsheetLink(url, message) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;border-radius:16px;padding:24px;max-width:400px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);';
            modal.innerHTML = `
                <div style="font-size:48px;margin-bottom:12px;">✅</div>
                <h3 style="margin:0 0 12px 0;color:#1E293B;">${message}</h3>
                <a href="${url}" target="_blank" style="display:inline-block;background:#0F9D58;color:white;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:bold;margin:12px 0;">📊 Buka Spreadsheet</a>
                <p style="margin:8px 0 0 0;font-size:12px;color:#64748B;">Klik tombol di atas untuk membuka</p>
                <button id="closeModalBtn" style="margin-top:16px;padding:8px 16px;border:1px solid #E2E8F0;background:white;border-radius:6px;cursor:pointer;">Tutup</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Close handlers
            document.getElementById('closeModalBtn').onclick = () => overlay.remove();
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        // ============================================
        // LOADING OVERLAY FUNCTIONS
        // ============================================
        let loadingOverlay = null;
        let progressInterval = null;
        let isDismissed = false;
        let currentHistoryId = null;
        let currentProgress = 0;

        function showLoadingOverlay(title, status, historyId = null) {
            // Remove existing if any
            hideLoadingOverlay(true); // force remove without animation
            isDismissed = false;
            currentHistoryId = historyId;
            currentProgress = 0;

            loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-modal">
                    <div class="loading-spinner"></div>
                    <div class="loading-title">${title}</div>
                    <div class="loading-status" id="loadingStatus">${status}</div>
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loadingProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="loading-percent" id="loadingPercent">0%</div>
                    <button class="loading-dismiss-btn" id="loadingDismissBtn">Lanjutkan di Background</button>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            // Dismiss button handler - keep progress running in background
            document.getElementById('loadingDismissBtn').onclick = () => {
                isDismissed = true;
                hideLoadingOverlay(true, true); // force=true, keepProgress=true
            };

            // Start progress simulation
            let progress = 0;
            progressInterval = setInterval(() => {
                // Simulate progress (slow down as it approaches 90%)
                if (progress < 30) {
                    progress += Math.random() * 8;
                } else if (progress < 60) {
                    progress += Math.random() * 4;
                } else if (progress < 85) {
                    progress += Math.random() * 2;
                } else if (progress < 95) {
                    progress += Math.random() * 0.5;
                }
                progress = Math.min(progress, 95);
                currentProgress = Math.round(progress);
                updateLoadingProgress(currentProgress);

                // Sync to history
                if (currentHistoryId) {
                    updateHistoryItemProgress(currentHistoryId, currentProgress);
                }
            }, 300);
        }

        function updateLoadingStatus(status) {
            const el = document.getElementById('loadingStatus');
            if (el) el.textContent = status;
        }

        function updateLoadingProgress(percent) {
            const fill = document.getElementById('loadingProgressFill');
            const text = document.getElementById('loadingPercent');
            if (fill) fill.style.width = percent + '%';
            if (text) text.textContent = percent + '%';
        }

        // Show progress modal for a specific history item (when clicking on processing item)
        function showProgressModal(historyId) {
            const item = processHistory.find(h => h.id === historyId);
            if (!item || item.status !== 'processing') return;

            // Create info modal
            const overlay = document.createElement('div');
            overlay.className = 'custom-modal-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';

            const elapsed = Math.round((Date.now() - item.startTime) / 1000);
            const elapsedText = elapsed < 60 ? `${elapsed} detik` : `${Math.floor(elapsed / 60)}m ${elapsed % 60}s`;

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;border-radius:16px;padding:24px;max-width:400px;width:90%;text-align:center;';
            modal.innerHTML = `
                <div style="font-size:48px;margin-bottom:12px;">🔄</div>
                <h3 style="margin:0 0 8px;color:#1E293B;font-size:1.1rem;">Sedang Diproses</h3>
                <p style="color:#64748B;font-size:0.85rem;margin:0 0 16px;word-break:break-word;">${item.filename}</p>
                <div style="background:#E2E8F0;border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px;">
                    <div style="background:linear-gradient(90deg,#2563EB,#4F46E5);height:100%;width:${item.progress || 0}%;transition:width 0.3s;"></div>
                </div>
                <p style="color:#64748B;font-size:0.8rem;margin:0 0 16px;">${item.progress || 0}% • Elapsed: ${elapsedText}</p>
                <p style="color:#94A3B8;font-size:0.75rem;margin:0 0 16px;">Proses berjalan di background. Halaman akan diupdate otomatis saat selesai.</p>
                <button id="closeProgressModalBtn" style="background:#2563EB;color:white;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:500;">OK, Tutup</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Close handlers
            document.getElementById('closeProgressModalBtn').onclick = () => overlay.remove();
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
        }

        function hideLoadingOverlay(force = false, keepProgress = false) {
            // Only clear interval if NOT keeping progress (i.e. process completed, not dismissed)
            if (progressInterval && !keepProgress) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            if (loadingOverlay) {
                if (force) {
                    loadingOverlay.remove();
                    loadingOverlay = null;
                } else {
                    // Complete progress to 100% before hiding
                    updateLoadingProgress(100);
                    setTimeout(() => {
                        if (loadingOverlay) {
                            loadingOverlay.remove();
                            loadingOverlay = null;
                        }
                    }, 300);
                }
            }
        }

        function wasDismissed() {
            return isDismissed;
        }

        // ============================================
        // TOAST NOTIFICATION FUNCTIONS
        // ============================================
        let toastContainer = null;

        function getToastContainer() {
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }
            return toastContainer;
        }

        function showToast(title, message, url = null, isError = false) {
            const container = getToastContainer();

            const toast = document.createElement('div');
            toast.className = 'toast' + (isError ? ' error' : '');

            const icon = isError ? '❌' : '✅';
            const actionHtml = url
                ? `<a href="${url}" target="_blank" class="toast-action">📊 Buka</a>`
                : '';

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                ${actionHtml}
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

            // Auto remove after 10 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        }
        // ============================================
        // PROCESS HISTORY FUNCTIONS
        // ============================================
        const HISTORY_STORAGE_KEY = 'excel_tools_export_history';
        let processHistory = [];

        function loadHistoryFromStorage() {
            try {
                const stored = localStorage.getItem(HISTORY_STORAGE_KEY);
                if (stored) {
                    processHistory = JSON.parse(stored);
                    // Clean up old processing items (they didn't complete)
                    processHistory = processHistory.filter(item => item.status !== 'processing');
                }
            } catch (e) {
                console.warn('Failed to load history from storage:', e);
                processHistory = [];
            }
            renderHistory();
        }

        function saveHistoryToStorage() {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(processHistory));
            } catch (e) {
                console.warn('Failed to save history to storage:', e);
            }
        }

        function generateHistoryId() {
            return 'h_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function addToHistory(filename, type, sheetName = null, cellRef = null) {
            const item = {
                id: generateHistoryId(),
                filename: filename,
                type: type, // 'new' or 'existing'
                sheetName: sheetName,
                cellRef: cellRef,
                status: 'processing',
                progress: 0,
                url: null,
                error: null,
                startTime: Date.now(),
                endTime: null
            };
            processHistory.unshift(item); // Add to beginning
            saveHistoryToStorage();
            renderHistory();
            return item.id;
        }

        function updateHistoryItem(id, updates) {
            const item = processHistory.find(h => h.id === id);
            if (item) {
                Object.assign(item, updates);
                if (updates.status === 'success' || updates.status === 'error') {
                    item.endTime = Date.now();
                }
                saveHistoryToStorage();
                renderHistory();
            }
        }

        // Update only progress (without full re-render for performance)
        function updateHistoryItemProgress(id, progress) {
            const item = processHistory.find(h => h.id === id);
            if (item && item.status === 'processing') {
                item.progress = progress;
                // Update DOM directly for performance
                const historyItem = document.querySelector(`.history-item[data-id="${id}"]`);
                if (historyItem) {
                    const progressFill = historyItem.querySelector('.history-progress-fill');
                    const progressText = historyItem.querySelector('.history-progress-text');
                    if (progressFill) {
                        progressFill.style.width = progress + '%';
                    }
                    if (progressText) {
                        progressText.textContent = progress + '% - Sedang diproses...';
                    }
                }
            }
        }

        function clearHistory() {
            if (confirm('Hapus semua riwayat export?')) {
                processHistory = [];
                saveHistoryToStorage();
                renderHistory();
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDuration(start, end) {
            if (!end) return '';
            const seconds = Math.round((end - start) / 1000);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');

            if (!container) return;

            // Build header HTML (always shown)
            const headerHtml = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 12px; border-bottom: 1px solid #E2E8F0;">
                <h3 style="margin: 0; color: #1E293B; font-size: 1rem;">📜 Riwayat Export</h3>
                <button class="history-clear-btn" id="clearHistoryBtn" style="margin: 0; ${processHistory.length === 0 ? 'display: none;' : ''}">🗑️ Hapus Semua</button>
            </div>`;

            // Empty state HTML
            const emptyStateHtml = `<div class="history-empty" id="historyEmpty" style="${processHistory.length > 0 ? 'display: none;' : ''}">
                <div class="history-empty-icon">📋</div>
                <p style="color: #475569; font-weight: 500;">Belum ada riwayat export</p>
                <p style="font-size: 0.8rem; color: #94A3B8;">Export ke Google Sheets untuk melihat riwayat di sini</p>
            </div>`;

            // If empty, just show header and empty state
            if (processHistory.length === 0) {
                container.innerHTML = headerHtml + emptyStateHtml;
                return;
            }

            // Build history items HTML
            let html = '';
            processHistory.forEach(item => {
                const statusIcon = item.status === 'processing' ? '🔄' :
                    item.status === 'success' ? '✅' : '❌';

                const meta = item.type === 'new'
                    ? 'Spreadsheet Baru'
                    : `Export ke "${item.sheetName}" (${item.cellRef || 'A1'})`;

                const timeInfo = formatTime(item.startTime);
                const duration = item.endTime ? ` • ${formatDuration(item.startTime, item.endTime)}` : '';

                let actionsHtml = '';
                if (item.status === 'success' && item.url) {
                    actionsHtml = `<a href="${item.url}" target="_blank" class="history-btn history-btn-primary">📊 Buka</a>`;
                } else if (item.status === 'error') {
                    actionsHtml = `<span class="history-btn history-btn-secondary" style="cursor: default;">Gagal</span>`;
                } else if (item.status === 'processing') {
                    actionsHtml = `<span class="history-btn history-btn-secondary" onclick="showProgressModal('${item.id}')" style="cursor: pointer;">👁️ Lihat</span>`;
                }

                let progressHtml = '';
                if (item.status === 'processing') {
                    progressHtml = `
                        <div class="history-progress">
                            <div class="history-progress-fill" style="width: ${item.progress || 0}%"></div>
                        </div>
                        <div class="history-progress-text" style="font-size: 0.7rem; color: #64748B; margin-top: 4px;">${item.progress || 0}% - Sedang diproses...</div>
                    `;
                }

                html += `
                    <div class="history-item ${item.status}" data-id="${item.id}">
                        <div class="history-icon">${statusIcon}</div>
                        <div class="history-content">
                            <div class="history-filename">${item.filename}</div>
                            <div class="history-meta">${timeInfo}${duration} • ${meta}</div>
                            ${item.error ? `<div class="history-meta" style="color: #DC2626;">${item.error}</div>` : ''}
                            ${progressHtml}
                        </div>
                        <div class="history-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                `;
            });
            // Set container with header, empty state (hidden), and items
            container.innerHTML = headerHtml + emptyStateHtml + html;

            // Re-attach clear button handler
            document.getElementById('clearHistoryBtn').onclick = clearHistory;
        }

        // Initialize history on load
        document.addEventListener('DOMContentLoaded', () => {
            loadHistoryFromStorage();

            // Clear history button
            const clearBtn = document.getElementById('clearHistoryBtn');
            if (clearBtn) {
                clearBtn.onclick = clearHistory;
            }
        });

        console.log('Excel Tools (AHA Commerce) v2.6 initialized');
    </script>
</body>

</html>