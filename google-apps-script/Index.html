<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* AHA Commerce Brand Colors */
        :root {
            --aha-blue-primary: #2563EB;
            --aha-blue-dark: #1D4ED8;
            --aha-blue-darker: #1E40AF;
            --aha-blue-light: #3B82F6;
            --aha-indigo: #4F46E5;
            --bg-gradient-start: #2563EB;
            --bg-gradient-end: #1D4ED8;
            --text-white: #FFFFFF;
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.7);
            --card-bg: #FFFBF0;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --button-dark: #1E3A5F;
            --success: #10B981;
            --success-bg: rgba(16, 185, 129, 0.15);
            --error: #EF4444;
            --error-bg: rgba(239, 68, 68, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --radius-full: 9999px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }

        .container {
            width: 100%;
            max-width: 580px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .header {
            padding: 28px 28px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-white);
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .main {
            padding: 28px;
        }

        /* Upload Zone - Card Style like AHA bubbles */
        .upload-zone {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
            border: none;
        }

        .upload-zone:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-zone.drag-over {
            transform: translateY(-4px);
            box-shadow: 0 0 0 3px var(--aha-blue-light), 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            color: var(--aha-blue-primary);
            margin-bottom: 16px;
        }

        .upload-zone h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--aha-blue-darker);
        }

        .upload-zone p {
            color: #64748B;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .browse-link {
            color: var(--aha-blue-primary);
            font-weight: 700;
            text-decoration: underline;
        }

        .hint {
            margin-top: 12px;
            font-size: 0.8rem !important;
            color: #94A3B8 !important;
        }

        /* Progress Section */
        .progress-section {
            display: none;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .progress-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--aha-blue-darker);
        }

        .progress-percent {
            color: var(--aha-blue-primary);
            font-weight: 700;
        }

        .progress-bar {
            height: 10px;
            background: #E2E8F0;
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--aha-blue-primary), var(--aha-indigo));
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        .progress-status {
            font-size: 0.85rem;
            color: #64748B;
            font-weight: 500;
        }

        /* File List Section */
        .file-list-section {
            display: none;
            margin-top: 20px;
        }

        .file-list-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .file-list-section h3 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-list {
            max-height: 180px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 8px;
            box-shadow: var(--card-shadow);
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: #475569;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .file-item-icon {
            color: var(--aha-blue-primary);
            flex-shrink: 0;
        }

        .file-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-item-rows {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--aha-blue-primary);
            background: rgba(37, 99, 235, 0.1);
            padding: 3px 10px;
            border-radius: var(--radius-full);
        }

        /* Result Section */
        .result-section {
            display: none;
            text-align: center;
            padding: 28px 0;
        }

        .result-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            box-shadow: var(--card-shadow);
        }

        .result-icon {
            color: var(--success);
            margin-bottom: 16px;
        }

        .result-section h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--aha-blue-darker);
            font-weight: 800;
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--aha-blue-primary), var(--aha-indigo));
            padding: 14px 24px;
            border-radius: var(--radius-md);
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-white);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Buttons - AHA Style */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 32px;
            background: var(--button-dark);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
            background: #162D4A;
        }

        .reset-btn {
            display: block;
            margin: 16px auto 0;
            padding: 10px 24px;
            background: transparent;
            color: #64748B;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            background: #F1F5F9;
            color: var(--aha-blue-darker);
            border-color: var(--aha-blue-primary);
        }

        /* Error Section */
        .error-section {
            display: none;
            text-align: center;
            padding: 28px 0;
        }

        .error-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .error-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            box-shadow: var(--card-shadow);
        }

        .error-icon {
            color: var(--error);
            margin-bottom: 16px;
        }

        .error-section h2 {
            color: var(--error);
            margin-bottom: 12px;
            font-weight: 800;
        }

        .error-message {
            color: #64748B;
            background: var(--error-bg);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            padding: 16px 28px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .footer a {
            color: var(--text-white);
            text-decoration: none;
            font-weight: 700;
        }

        /* Scrollbar */
        .file-list::-webkit-scrollbar {
            width: 6px;
        }

        .file-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: rgba(37, 99, 235, 0.3);
            border-radius: 3px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: rgba(37, 99, 235, 0.5);
        }

        .upload-zone.hidden {
            display: none;
        }

        /* Column Selector Section */
        .column-selector-section {
            display: none;
            margin-top: 20px;
        }

        .column-selector-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .column-selector-section h3 {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .column-selector-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .select-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .select-actions button {
            padding: 8px 16px;
            border: 2px solid var(--aha-blue-primary);
            background: transparent;
            color: var(--aha-blue-primary);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .select-actions button:hover {
            background: var(--aha-blue-primary);
            color: white;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 4px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(37, 99, 235, 0.05);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .column-item:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .column-item.selected {
            background: rgba(37, 99, 235, 0.15);
            border-color: var(--aha-blue-primary);
        }

        .column-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--aha-blue-primary);
            cursor: pointer;
        }

        .column-item label {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .column-count {
            text-align: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E2E8F0;
        }

        .column-count span {
            font-size: 0.9rem;
            color: #64748B;
            font-weight: 500;
        }

        .column-count strong {
            color: var(--aha-blue-primary);
        }

        .proceed-btn {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 14px 32px;
            background: var(--button-dark);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
        }

        .proceed-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
            background: #162D4A;
        }

        .proceed-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .column-search {
            margin-bottom: 12px;
        }

        .column-search input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid #E2E8F0;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s ease;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") 12px center no-repeat;
        }

        .column-search input:focus {
            outline: none;
            border-color: var(--aha-blue-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .column-search input::placeholder {
            color: #94A3B8;
        }

        .column-item.hidden {
            display: none;
        }

        .column-grid::-webkit-scrollbar {
            width: 6px;
        }

        .column-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .column-grid::-webkit-scrollbar-thumb {
            background: rgba(37, 99, 235, 0.3);
            border-radius: 3px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .tab-btn.active {
            background: var(--card-bg);
            color: var(--aha-blue-primary);
            box-shadow: var(--card-shadow);
        }

        .tab-btn svg {
            width: 18px;
            height: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @media (max-width: 480px) {
            .container {
                border-radius: var(--radius-lg);
            }

            .header,
            .main {
                padding: 20px;
            }

            .upload-zone {
                padding: 32px 16px;
            }

            .logo h1 {
                font-size: 1.4rem;
            }

            .result-stats {
                gap: 10px;
            }

            .stat-item {
                padding: 12px 18px;
                min-width: 100px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <!-- AHA Commerce Logo -->
                <svg class="logo-icon" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 3L38 36H4L21 3Z" fill="white" />
                    <path d="M21 12L30 30H12L21 12Z" fill="#2563EB" />
                </svg>
                <h1>Excel Tools</h1>
            </div>
            <p class="subtitle">Pilih kolom atau gabungkan file Excel dengan mudah</p>
        </header>

        <main class="main">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="columnTab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    Pilih Kolom
                </button>
                <button class="tab-btn" data-tab="mergeTab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" />
                    </svg>
                    Gabung File
                </button>
            </div>

            <!-- Tab: Pilih Kolom (Single File) -->
            <div class="tab-content active" id="columnTab">
                <div class="upload-zone" id="singleUploadZone">
                    <input type="file" id="singleFileInput" accept=".xlsx,.xls" hidden>
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="56" height="56" viewBox="0 0 56 56" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M28 38V18M28 18L20 26M28 18L36 26" stroke="currentColor" stroke-width="3"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 38V42C10 44.2091 11.7909 46 14 46H42C44.2091 46 46 44.2091 46 42V38"
                                    stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h2>Upload File Excel</h2>
                        <p>Drag & drop file Excel di sini, atau <span class="browse-link">browse</span></p>
                        <p class="hint">File Excel (.xlsx) untuk dipilih kolomnya</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Gabung File (ZIP) -->
            <div class="tab-content" id="mergeTab">
                <div class="upload-zone" id="zipUploadZone">
                    <input type="file" id="zipFileInput" accept=".zip" hidden>
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="56" height="56" viewBox="0 0 56 56" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M28 38V18M28 18L20 26M28 18L36 26" stroke="currentColor" stroke-width="3"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M10 38V42C10 44.2091 11.7909 46 14 46H42C44.2091 46 46 44.2091 46 42V38"
                                    stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                        </div>
                        <h2>Upload File ZIP</h2>
                        <p>Drag & drop file ZIP di sini, atau <span class="browse-link">browse</span></p>
                        <p class="hint">File ZIP berisi file Excel (.xlsx) yang akan digabungkan</p>
                    </div>
                </div>
            </div>

            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <span class="progress-title" id="progressTitle">Memproses...</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-status" id="progressStatus">Menunggu...</div>
            </div>

            <div class="file-list-section" id="fileListSection">
                <h3>File Excel Ditemukan</h3>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="column-selector-section" id="columnSelectorSection">
                <h3>Pilih Kolom untuk Download</h3>
                <div class="column-selector-card">
                    <div class="select-actions">
                        <button type="button" id="selectAllBtn">✓ Select All</button>
                        <button type="button" id="deselectAllBtn">✗ Deselect All</button>
                    </div>
                    <div class="column-search">
                        <input type="text" id="columnSearchInput" placeholder="Cari nama kolom...">
                    </div>
                    <div class="column-grid" id="columnGrid"></div>
                    <div class="column-count">
                        <span><strong id="selectedCount">0</strong> dari <strong id="totalCount">0</strong> kolom
                            dipilih</span>
                    </div>
                    <button class="proceed-btn" id="proceedBtn">Download Kolom Terpilih</button>
                </div>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-card">
                    <div class="result-icon">
                        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" />
                            <path d="M18 28L24 34L38 20" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </div>
                    <h2>Merge Berhasil!</h2>
                    <div class="result-stats" id="resultStats"></div>
                    <button class="download-btn" id="downloadBtn">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 3V11M9 11L5 7M9 11L13 7" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3 11V13C3 14.1046 3.89543 15 5 15H13C14.1046 15 15 14.1046 15 13V11"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        Download Hasil Merge
                    </button>
                    <button class="reset-btn" id="resetBtn">Upload File Lain</button>
                </div>
            </div>

            <div class="error-section" id="errorSection">
                <div class="error-card">
                    <div class="error-icon">
                        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="3" />
                            <path d="M20 20L36 36M36 20L20 36" stroke="currentColor" stroke-width="3"
                                stroke-linecap="round" />
                        </svg>
                    </div>
                    <h2>Terjadi Kesalahan</h2>
                    <p class="error-message" id="errorMessage"></p>
                    <button class="reset-btn" id="errorResetBtn">Coba Lagi</button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Excel Tools v2.0 | <a href="#">AHA Commerce</a> Internal Tool</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // DOM Elements - Tabs
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        let currentTab = 'columnTab';

        // DOM Elements - Single File Tab
        const singleUploadZone = document.getElementById('singleUploadZone');
        const singleFileInput = document.getElementById('singleFileInput');

        // DOM Elements - ZIP Merge Tab
        const zipUploadZone = document.getElementById('zipUploadZone');
        const zipFileInput = document.getElementById('zipFileInput');

        // DOM Elements - Shared
        const progressSection = document.getElementById('progressSection');
        const progressTitle = document.getElementById('progressTitle');
        const progressPercent = document.getElementById('progressPercent');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const fileListSection = document.getElementById('fileListSection');
        const fileList = document.getElementById('fileList');
        const resultSection = document.getElementById('resultSection');
        const resultStats = document.getElementById('resultStats');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        const errorResetBtn = document.getElementById('errorResetBtn');

        let mergedWorkbook = null;
        let outputFileName = 'merged_excel.xlsx';
        let allMergedData = [];  // Store all data for column filtering
        let headerRow = null;    // Store header row separately
        let currentMode = 'single'; // 'single' or 'merge'

        // Tab Navigation
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        function switchTab(tabId) {
            currentTab = tabId;
            tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
            tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
            resetApp(); // Reset state when switching tabs
        }

        // Event Listeners - Single File Tab
        singleUploadZone.addEventListener('click', () => singleFileInput.click());
        singleUploadZone.addEventListener('dragover', (e) => handleDragOver(e, singleUploadZone));
        singleUploadZone.addEventListener('dragleave', (e) => handleDragLeave(e, singleUploadZone));
        singleUploadZone.addEventListener('drop', (e) => handleSingleDrop(e));
        singleFileInput.addEventListener('change', handleSingleFileSelect);

        // Event Listeners - ZIP Merge Tab
        zipUploadZone.addEventListener('click', () => zipFileInput.click());
        zipUploadZone.addEventListener('dragover', (e) => handleDragOver(e, zipUploadZone));
        zipUploadZone.addEventListener('dragleave', (e) => handleDragLeave(e, zipUploadZone));
        zipUploadZone.addEventListener('drop', (e) => handleZipDrop(e));
        zipFileInput.addEventListener('change', handleZipFileSelect);

        // Shared Event Listeners
        downloadBtn.addEventListener('click', downloadMergedFile);
        resetBtn.addEventListener('click', resetApp);
        errorResetBtn.addEventListener('click', resetApp);

        // Column selector elements
        const columnSelectorSection = document.getElementById('columnSelectorSection');
        const columnGrid = document.getElementById('columnGrid');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const proceedBtn = document.getElementById('proceedBtn');
        const selectedCountEl = document.getElementById('selectedCount');
        const totalCountEl = document.getElementById('totalCount');
        const columnSearchInput = document.getElementById('columnSearchInput');

        selectAllBtn.addEventListener('click', () => toggleAllColumns(true));
        deselectAllBtn.addEventListener('click', () => toggleAllColumns(false));
        proceedBtn.addEventListener('click', downloadMergedFile);
        columnSearchInput.addEventListener('input', filterColumns);

        function handleDragOver(e, zone) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.add('drag-over');
        }

        function handleDragLeave(e, zone) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.remove('drag-over');
        }

        // Single File Handlers
        function handleSingleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            singleUploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) processSingleFile(files[0]);
        }

        function handleSingleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processSingleFile(files[0]);
        }

        // ZIP File Handlers
        function handleZipDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            zipUploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) processZipFile(files[0]);
        }

        function handleZipFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) processZipFile(files[0]);
        }

        // Process Single Excel File
        async function processSingleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showError('File harus berformat .xlsx atau .xls');
                return;
            }

            currentMode = 'single';
            outputFileName = file.name.replace(/\.(xlsx|xls)$/i, '_filtered.xlsx');
            singleUploadZone.classList.add('hidden');
            showProgress();

            try {
                updateProgress(20, 'Membaca file Excel...');
                const excelData = await readFileAsArrayBuffer(file);

                updateProgress(50, 'Memproses data...');
                const workbook = XLSX.read(excelData, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                if (jsonData.length === 0) {
                    throw new Error('File Excel kosong');
                }

                // Store data globally
                allMergedData = jsonData;
                headerRow = jsonData[0];

                updateProgress(100, 'Selesai!');

                setTimeout(() => {
                    showColumnSelector(headerRow, 1, jsonData.length - 1);
                }, 500);

            } catch (error) {
                console.error('Error processing file:', error);
                showError(error.message || 'Terjadi kesalahan saat memproses file');
            }
        }

        // Process ZIP File (Merge)
        async function processZipFile(file) {
            if (!file.name.toLowerCase().endsWith('.zip')) {
                showError('File harus berformat .zip');
                return;
            }

            currentMode = 'merge';

            outputFileName = file.name.replace('.zip', '_merged.xlsx');
            zipUploadZone.classList.add('hidden');
            showProgress();

            try {
                updateProgress(10, 'Membaca file ZIP...');
                const zipData = await readFileAsArrayBuffer(file);

                updateProgress(20, 'Mengekstrak file ZIP...');
                const zip = await JSZip.loadAsync(zipData);

                updateProgress(30, 'Mencari file Excel...');
                const excelFiles = [];

                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir && relativePath.toLowerCase().endsWith('.xlsx')) {
                        if (!relativePath.startsWith('~$') && !relativePath.includes('/__MACOSX/')) {
                            excelFiles.push({
                                path: relativePath,
                                name: relativePath.split('/').pop(),
                                entry: zipEntry
                            });
                        }
                    }
                });

                if (excelFiles.length === 0) {
                    throw new Error('Tidak ditemukan file Excel (.xlsx) dalam ZIP');
                }

                excelFiles.sort((a, b) => naturalSort(a.name, b.name));

                updateProgress(40, `Memproses ${excelFiles.length} file Excel...`);

                const allData = [];
                let currentHeaderRow = null;
                let totalRows = 0;
                const fileStats = [];

                for (let i = 0; i < excelFiles.length; i++) {
                    const excelFile = excelFiles[i];
                    const progressPct = 40 + Math.round((i / excelFiles.length) * 40);
                    updateProgress(progressPct, `Memproses: ${excelFile.name}`);

                    const excelData = await excelFile.entry.async('arraybuffer');
                    const workbook = XLSX.read(excelData, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

                    if (jsonData.length === 0) continue;

                    let dataRows;
                    if (currentHeaderRow === null) {
                        currentHeaderRow = jsonData[0];
                        dataRows = jsonData;
                    } else {
                        dataRows = jsonData.slice(1);
                    }

                    const rowCount = dataRows.length - (currentHeaderRow === jsonData[0] ? 1 : 0);
                    fileStats.push({ name: excelFile.name, rows: rowCount });
                    totalRows += rowCount;
                    allData.push(...dataRows);
                }

                displayFileList(fileStats);

                updateProgress(85, 'Menyiapkan pemilihan kolom...');

                // Store data globally for column filtering
                allMergedData = allData;
                headerRow = currentHeaderRow;

                updateProgress(100, 'Selesai!');

                setTimeout(() => {
                    showColumnSelector(currentHeaderRow, excelFiles.length, totalRows);
                }, 500);

            } catch (error) {
                console.error('Error processing file:', error);
                showError(error.message || 'Terjadi kesalahan saat memproses file');
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Gagal membaca file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function naturalSort(a, b) {
            const ax = [], bx = [];
            a.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { ax.push([$1 || Infinity, $2 || '']) });
            b.replace(/(\d+)|(\D+)/g, (_, $1, $2) => { bx.push([$1 || Infinity, $2 || '']) });
            while (ax.length && bx.length) {
                const an = ax.shift();
                const bn = bx.shift();
                const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]);
                if (nn) return nn;
            }
            return ax.length - bx.length;
        }

        function calculateColumnWidths(data) {
            if (!data || data.length === 0) return [];
            const colWidths = [];
            const maxWidth = 50;
            const minWidth = 10;
            const maxCols = Math.max(...data.map(row => (row ? row.length : 0)));
            for (let col = 0; col < maxCols; col++) {
                let maxLen = minWidth;
                const sampleSize = Math.min(data.length, 100);
                for (let row = 0; row < sampleSize; row++) {
                    if (data[row] && data[row][col] !== undefined) {
                        const cellLen = String(data[row][col]).length;
                        if (cellLen > maxLen) maxLen = cellLen;
                    }
                }
                colWidths.push({ wch: Math.min(maxLen + 2, maxWidth) });
            }
            return colWidths;
        }

        function displayFileList(fileStats) {
            fileList.innerHTML = fileStats.map(file => `
                <div class="file-item">
                    <div class="file-item-icon">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M3 2H10L13 5V14H3V2Z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M10 2V5H13" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <span class="file-item-name">${file.name}</span>
                    <span class="file-item-rows">${file.rows.toLocaleString()} rows</span>
                </div>
            `).join('');
            fileListSection.classList.add('active');
        }

        function updateProgress(percent, status) {
            progressPercent.textContent = `${percent}%`;
            progressFill.style.width = `${percent}%`;
            progressStatus.textContent = status;
        }

        function showProgress() {
            progressSection.classList.add('active');
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            updateProgress(0, 'Memulai...');
        }

        function showResult(fileCount, rowCount) {
            progressSection.classList.remove('active');
            resultSection.classList.add('active');
            resultStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${fileCount}</div>
                    <div class="stat-label">File Digabung</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${rowCount.toLocaleString()}</div>
                    <div class="stat-label">Total Baris</div>
                </div>
            `;
        }

        function showError(message) {
            singleUploadZone.classList.add('hidden');
            zipUploadZone.classList.add('hidden');
            progressSection.classList.remove('active');
            resultSection.classList.remove('active');
            fileListSection.classList.remove('active');
            errorSection.classList.add('active');
            errorMessage.textContent = message;
        }

        function downloadMergedFile() {
            const selectedColumns = getSelectedColumns();
            if (selectedColumns.length === 0) {
                showError('Pilih minimal 1 kolom untuk download');
                return;
            }

            try {
                // Filter data by selected columns
                const filteredData = allMergedData.map(row =>
                    selectedColumns.map(colIndex => row[colIndex] !== undefined ? row[colIndex] : '')
                );

                // Create workbook with filtered data
                mergedWorkbook = XLSX.utils.book_new();
                const mergedSheet = XLSX.utils.aoa_to_sheet(filteredData);
                const colWidths = calculateColumnWidths(filteredData);
                mergedSheet['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(mergedWorkbook, mergedSheet, 'Merged Data');

                const wbout = XLSX.write(mergedWorkbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, outputFileName);
            } catch (error) {
                console.error('Error downloading file:', error);
                showError('Gagal mendownload file');
            }
        }

        function resetApp() {
            mergedWorkbook = null;
            allMergedData = [];
            headerRow = null;
            outputFileName = 'merged_excel.xlsx';
            singleFileInput.value = '';
            zipFileInput.value = '';
            singleUploadZone.classList.remove('hidden');
            zipUploadZone.classList.remove('hidden');
            progressSection.classList.remove('active');
            fileListSection.classList.remove('active');
            columnSelectorSection.classList.remove('active');
            resultSection.classList.remove('active');
            errorSection.classList.remove('active');
            fileList.innerHTML = '';
            columnGrid.innerHTML = '';
            updateProgress(0, 'Menunggu...');
        }

        // Column Selector Functions
        function showColumnSelector(headers, fileCount, rowCount) {
            progressSection.classList.remove('active');
            columnSelectorSection.classList.add('active');

            // Render column checkboxes
            columnGrid.innerHTML = headers.map((header, index) => {
                const displayName = header || `Kolom ${index + 1}`;
                return `
                    <div class="column-item selected" data-index="${index}">
                        <input type="checkbox" id="col_${index}" checked>
                        <label for="col_${index}" title="${displayName}">${displayName}</label>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.column-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                    item.classList.toggle('selected', item.querySelector('input').checked);
                    updateColumnCount();
                });
            });

            totalCountEl.textContent = headers.length;
            updateColumnCount();

            // Store stats for result display
            columnSelectorSection.dataset.fileCount = fileCount;
            columnSelectorSection.dataset.rowCount = rowCount;
        }

        function toggleAllColumns(selectAll) {
            // Only toggle visible (non-hidden) columns
            document.querySelectorAll('.column-item:not(.hidden)').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = selectAll;
                item.classList.toggle('selected', selectAll);
            });
            updateColumnCount();
        }

        function filterColumns() {
            const searchTerm = columnSearchInput.value.toLowerCase().trim();
            document.querySelectorAll('.column-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const matches = label.includes(searchTerm);
                item.classList.toggle('hidden', !matches);
            });
        }

        function getSelectedColumns() {
            const selected = [];
            document.querySelectorAll('.column-item input:checked').forEach(checkbox => {
                const item = checkbox.closest('.column-item');
                selected.push(parseInt(item.dataset.index));
            });
            return selected.sort((a, b) => a - b);
        }

        function updateColumnCount() {
            const count = document.querySelectorAll('.column-item input:checked').length;
            selectedCountEl.textContent = count;
            proceedBtn.disabled = count === 0;
            proceedBtn.textContent = count === 0 ? 'Pilih Kolom Terlebih Dahulu' : `Download ${count} Kolom Terpilih`;
        }

        console.log('Excel Tools (AHA Commerce) v2.0 initialized');
    </script>
</body>

</html>